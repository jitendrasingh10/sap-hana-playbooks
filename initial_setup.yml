---

- name: Set up VM
  hosts: "{{ vm_prefix }}*"
  vars:
    activation_keys:
      S4_Image: SAP S4 Server
      HANA_Image: SAP HANA Server

  pre_tasks:
    - block:
        - name: Subscribe to our Satellite using our activation key
          redhat_subscription:
            state: present
            activationkey: "{{ activation_keys[foreman.hostgroup_name] | default('SAP HANA Server') }}"
            org_id: Shadow_Man
            auto_attach: true
          register: subscribe_to_satelite
          until: subscribe_to_satelite is success
          delay: 3
          retries: 10

      rescue:
        - debug:
            msg: "continue"


#    - name: Subscribe to our Satellite using our activation key
#      command: subscription-manager register --org Shadow_Man --activationkey "{{ activation_keys[foreman.hostgroup_name] | default('SAP HANA Server') }}"
#      failed_when: false

    # this shouldn't be needed normally but auto-attach doesn't seem to always work
    - name: attach susbscription
      command: subscription-manager attach
      failed_when: false

    - name: unset role and usage
      command: "{{ item }}"
      failed_when: false
      loop:
        - syspurpose unset role
        - syspurpose unset usage

    - name: check subscription status
      command: subscription-manager status
      register: sat_sub_status
      failed_when: false

    - name: output subscription status
      debug:
        msg: "{{ sat_sub_status }}"

    - name: build hosts file
      lineinfile:
        dest: /etc/hosts
        regexp: '.*{{ item }}$'
        line: "{{ hostvars[item].ansible_default_ipv4.address }} {{ item }} {{ hostvars[item].ansible_hostname }}"
        state: present
      when: hostvars[item].ansible_default_ipv4.address is defined
      loop: "{{ play_hosts }}"

    - name: add vip to hosts file for db
      lineinfile:
        dest: /etc/hosts
        regexp: '.*{{ sap_s4hana_deployment_db_host }}$'
        line: "{{ sap_hana_ha_pacemaker_vip }} {{ sap_s4hana_deployment_db_host }} {{ sap_s4hana_deployment_db_host }}.{{ foreman.domain_name }}"
        state: present
      when:
        - sap_s4hana_deployment_db_host is defined
        - sap_hana_ha_pacemaker_vip is defined

    - name: ensure software repo directory exists
      file:
        path: "{{ local_repo_path }}"
        state: directory

    - name: ensure prereq packages are present
      package:
        name:
          - compat-sap-c++-9
          - nfs-utils
          - nfs4-acl-tools

    - name: ensure software repo is mounted
      mount:
        path: "{{ local_repo_path }}"
        src: "{{ software_repo_nfs_server }}:/{{ software_repo_path }}"
        fstype: nfs
        opts: rw,_netdev
        state: mounted

  roles:
    - storage

  post_tasks:
    - name: ensure installation directories exists
      file:
        path: "{{ sap_install_sapcar_path }}"
        state: directory
      when: sap_install_sapcar_path is defined

    - name: ensure SAPCAR is copied to target directories
      copy:
        src: "{{ local_repo_path }}/SAPCAR/{{ sap_install_sapcar_file_name }}"
        dest: "{{ sap_install_sapcar_path }}/{{ sap_install_sapcar_file_name }}"
        remote_src: yes
        mode: u+rwx,g+rx,o+rx
      when: sap_install_sapcar_path is defined

    - name: set grub to default to the old kernel for kernel patching scenario
      shell: /usr/sbin/grubby --set-default-index=1

    - name: Reboot the machine
      reboot: